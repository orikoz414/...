from google.colab import drive
drive.mount('/content/drive')

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
import os
import kagglehub

plt.rcParams['font.size'] = 12
plt.rcParams['axes.titlesize'] = 14
sns.set_style("whitegrid")

def download_kaggle_dataset():
    try:
        path = kagglehub.dataset_download("nabeelqureshitiii/student-performance-dataset")
        
        csv_files = []
        for root, dirs, files in os.walk(path):
            for file in files:
                if file.endswith('.csv'):
                    csv_files.append(os.path.join(root, file))
        
        if not csv_files:
            return None
        
        df = pd.read_csv(csv_files[0])
        return df
        
    except Exception as e:
        return None

def prepare_training_data_from_kaggle(df):
    if df is None or len(df) == 0:
        return None
    
    attendance_keywords = ['attendance', 'attend', 'presence', 'percentage', '%']
    grade_keywords = ['grade', 'score', 'mark', 'gpa', 'average', 'avg']
    
    attendance_cols = [col for col in df.columns if any(keyword in col.lower() for keyword in attendance_keywords)]
    grade_cols = [col for col in df.columns if any(keyword in col.lower() for keyword in grade_keywords)]
    
    attendance_col = attendance_cols[0] if attendance_cols else None
    grade_col = grade_cols[0] if grade_cols else None
    
    training_data = []
    specialties = ['—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ', '–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ', '–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ', '–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ', '—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ']
    
    num_samples = min(350, len(df))
    
    for i in range(num_samples):
        row = df.iloc[i]
        
        if attendance_col and pd.notna(row[attendance_col]):
            attendance_val = float(row[attendance_col])
            if 0 <= attendance_val <= 1:
                attendance = attendance_val * 100
            elif attendance_val > 100:
                attendance = min(attendance_val / 10, 100)
            else:
                attendance = min(max(attendance_val, 0), 100)
        else:
            attendance = np.random.randint(60, 96)
        
        if grade_col and pd.notna(row[grade_col]):
            grade_val = float(row[grade_col])
            if grade_val > 5:
                avg_grade = 2.0 + (grade_val / 100 * 3.0)
            else:
                avg_grade = min(max(grade_val, 2.0), 5.0)
        else:
            avg_grade = np.random.uniform(2.0, 5.0)
        
        extracurricular = np.random.choice([0, 1])
        motivation = int(3 + (avg_grade - 2.0) * (7 / 3.0))
        late_count = int((100 - attendance) / 15)
        
        if attendance > 85 and avg_grade > 4.0:
            specialty = '–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ'
        elif avg_grade > 3.5 and extracurricular == 1:
            specialty = '–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ'
        elif motivation > 7:
            specialty = '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ'
        elif late_count > 5:
            specialty = '—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ'
        else:
            specialty = np.random.choice(specialties)
        
        training_data.append({
            'attendance': attendance,
            'avg_grade': avg_grade,
            'extracurricular': extracurricular,
            'motivation': motivation,
            'late_count': late_count,
            'specialty': specialty
        })
    
    return pd.DataFrame(training_data)

def get_specialty_info(choice):
    specialties = {
        1: '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ',
        2: '–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ',
        3: '–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ',
        4: '–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ',
        5: '—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ'
    }
    
    typical_values = {
        '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ': (82.0, 3.8, 6, 3),
        '–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ': (85.0, 4.0, 7, 2),
        '–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ': (88.0, 4.3, 8, 1),
        '–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ': (84.0, 3.9, 7, 2),
        '—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ': (80.0, 3.7, 6, 4)
    }
    
    if choice not in specialties:
        raise ValueError("–í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5")
    
    specialty = specialties[choice]
    typical_att, typical_grade, typical_motiv, typical_late = typical_values[specialty]
    
    return specialty, typical_att, typical_grade, typical_motiv, typical_late

def validate_input(attendance, avg_grade, motivation, late_count, extracurricular):
    if not (0 <= attendance <= 100):
        raise ValueError("–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100")
    if not (2.0 <= avg_grade <= 5.0):
        raise ValueError("–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –æ—Ç 2.0 –¥–æ 5.0")
    if motivation < 1 or motivation > 10:
        raise ValueError("–ú–æ—Ç–∏–≤–∞—Ü–∏—è –æ—Ç 1 –¥–æ 10")
    if late_count < 0:
        raise ValueError("–û–ø–æ–∑–¥–∞–Ω–∏—è –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏")
    if extracurricular not in [0, 1]:
        raise ValueError("–í–Ω–µ—É—á–µ–±–∫–∞: 1 ‚Äî –¥–∞, 0 ‚Äî –Ω–µ—Ç")

def create_visualizations(results, n_new):
    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    fig.suptitle(f"–ê–ù–ê–õ–ò–ó –£–°–ü–ï–í–ê–ï–ú–û–°–¢–ò: {n_new} –°–¢–£–î–ï–ù–¢–û–í", fontsize=16, weight='bold')
    
    status_counts = results['–°—Ç–∞—Ç—É—Å'].value_counts()
    colors = ['#4CAF50' if status == '—É—Å–ø–µ—à–Ω—ã–π' else '#FF9800' for status in status_counts.index]
    axes[0, 0].pie(status_counts.values, labels=status_counts.index, autopct='%1.1f%%',
                   colors=colors, startangle=90)
    axes[0, 0].set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º")
    
    if len(results['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'].unique()) > 1:
        specialty_performance = results.groupby('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ')['–°—Ç–∞—Ç—É—Å'].apply(
            lambda x: (x == '—É—Å–ø–µ—à–Ω—ã–π').mean()
        ).sort_values(ascending=False)
        
        colors_spec = ['#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#795548']
        specialty_performance.plot(kind='bar', ax=axes[0, 1], color=colors_spec, alpha=0.8)
        axes[0, 1].set_title("–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º")
        axes[0, 1].set_ylabel("–î–æ–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
        axes[0, 1].tick_params(axis='x', rotation=45)
    else:
        axes[0, 1].text(0.5, 0.5, '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π\n–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 
                       ha='center', va='center', fontsize=12)
        axes[0, 1].set_title("–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º")
    
    if n_new > 0:
        axes[1, 0].hist(results['–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å'], bins=10, color='#2196F3', alpha=0.7, edgecolor='black')
        axes[1, 0].axvline(results['–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å'].mean(), color='red', linestyle='dashed', linewidth=1)
        axes[1, 0].set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏")
        axes[1, 0].set_xlabel("–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (%)")
        axes[1, 0].set_ylabel("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
        axes[1, 0].grid(True, alpha=0.3)
    
    if n_new > 0:
        axes[1, 1].hist(results['–°—Ä_–æ—Ü–µ–Ω–∫–∞'], bins=10, color='#4CAF50', alpha=0.7, edgecolor='black')
        axes[1, 1].axvline(results['–°—Ä_–æ—Ü–µ–Ω–∫–∞'].mean(), color='red', linestyle='dashed', linewidth=1)
        axes[1, 1].set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö –æ—Ü–µ–Ω–æ–∫")
        axes[1, 1].set_xlabel("–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞")
        axes[1, 1].set_ylabel("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
        axes[1, 1].grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()

def print_recommendations(results, n_new):
    at_risk_count = (results['–°—Ç–∞—Ç—É—Å'] == '–≤ –≥—Ä—É–ø–ø–µ —Ä–∏—Å–∫–∞').sum()
    
    print(f"\nüìà –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
    print(f"–í—Å–µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {n_new} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
    print(f"–í –≥—Ä—É–ø–ø–µ —Ä–∏—Å–∫–∞: {at_risk_count} ({at_risk_count/n_new:.1%})")
    
    print(f"\nüéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
    
    if at_risk_count == 0:
        print("‚úÖ –û—Ç–ª–∏—á–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏! –í—Å–µ —Å—Ç—É–¥–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ—Å–≤–∞–∏–≤–∞—é—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É.")
        return
    
    print(f"‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ {at_risk_count} —Å—Ç—É–¥–µ–Ω—Ç—É(–∞–º):")
    
    risk_students = results[results['–°—Ç–∞—Ç—É—Å'] == '–≤ –≥—Ä—É–ø–ø–µ —Ä–∏—Å–∫–∞']
    
    for idx, student in risk_students.iterrows():
        print(f"\n   üë§ {student['–°—Ç—É–¥–µ–Ω—Ç']} ({student['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']}):")
        issues = []
        
        if student['–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å'] < 75:
            issues.append(f"–Ω–∏–∑–∫–∞—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å ({student['–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å']:.1f}%)")
        if student['–°—Ä_–æ—Ü–µ–Ω–∫–∞'] < 3.5:
            issues.append(f"–Ω–∏–∑–∫–∞—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å ({student['–°—Ä_–æ—Ü–µ–Ω–∫–∞']:.2f})")
        if student['–û–ø–æ–∑–¥–∞–Ω–∏—è'] > 4:
            issues.append(f"—á–∞—Å—Ç—ã–µ –æ–ø–æ–∑–¥–∞–Ω–∏—è ({student['–û–ø–æ–∑–¥–∞–Ω–∏—è']})")
        if student['–í–Ω–µ—É—á–µ–±–∫–∞'] == '–ù–µ—Ç':
            issues.append("–Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤–æ –≤–Ω–µ—É—á–µ–±–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")
        
        if issues:
            print(f"      ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã: {', '.join(issues)}")
        else:
            print(f"      ‚Ä¢ –û–±—â–∞—è –Ω–∏–∑–∫–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è")

print("üéì –°–ò–°–¢–ï–ú–ê –ê–ù–ê–õ–ò–ó–ê –£–°–ü–ï–í–ê–ï–ú–û–°–¢–ò –°–¢–£–î–ï–ù–¢–û–í")

raw_data = download_kaggle_dataset()

if raw_data is not None:
    data = prepare_training_data_from_kaggle(raw_data)
else:
    specialties = ['—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ'] * 70 + ['–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ'] * 70 + \
                  ['–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ'] * 70 + ['–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ'] * 70 + \
                  ['—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ'] * 70
    
    demo_data = []
    for i in range(350):
        demo_data.append({
            'attendance': np.random.randint(60, 96),
            'avg_grade': np.random.uniform(2.0, 5.0),
            'extracurricular': np.random.choice([0, 1]),
            'motivation': np.random.randint(3, 11),
            'late_count': np.random.randint(0, 10),
            'specialty': specialties[i % len(specialties)]
        })
    
    data = pd.DataFrame(demo_data)

performance_score = (
    data['attendance'] * 0.3 +
    data['avg_grade'] * 15 +
    data['motivation'] * 2 +
    data['extracurricular'] * 3 -
    data['late_count'] * 1.2
)

risk_threshold = performance_score.quantile(0.25)
data['performance'] = (performance_score > risk_threshold).astype(int)

print(f"üìä –û–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö: {len(data)} –∑–∞–ø–∏—Å–µ–π")

X = data[['attendance', 'avg_grade', 'extracurricular', 'motivation', 'late_count']]
y = data['performance']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

accuracy = model.score(X_test, y_test)
print(f"‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞. –¢–æ—á–Ω–æ—Å—Ç—å: {accuracy:.1%}")

print("\n" + "=" * 60)
print("üìä –ê–ù–ê–õ–ò–ó –ù–û–í–´–• –°–¢–£–î–ï–ù–¢–û–í")
print("=" * 60)

try:
    n_new = int(input("\n–°–∫–æ–ª—å–∫–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å? "))
    if n_new <= 0:
        raise ValueError("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.")
    
    new_students = []
    
    for i in range(n_new):
        print(f"\nüë§ –°—Ç—É–¥–µ–Ω—Ç {i + 1}")
        print("-" * 30)
        
        print("\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:")
        print("1 - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ")
        print("2 - –ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ")
        print("3 - –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ")
        print("4 - –ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ")
        print("5 - –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ")
        
        choice = int(input("–í–∞—à –≤—ã–±–æ—Ä (1-5): "))
        
        specialty, typical_att, typical_grade, typical_motiv, typical_late = get_specialty_info(choice)
        
        attendance = float(input(f"–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (%) [—Å—Ä–µ–¥–Ω–µ–µ {typical_att}]: ") or typical_att)
        avg_grade = float(input(f"–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ [—Å—Ä–µ–¥–Ω–µ–µ {typical_grade}]: ") or typical_grade)
        motivation = int(input(f"–ú–æ—Ç–∏–≤–∞—Ü–∏—è (1-10) [—Å—Ä–µ–¥–Ω–µ–µ {typical_motiv}]: ") or typical_motiv)
        late_count = int(input(f"–û–ø–æ–∑–¥–∞–Ω–∏–π –∑–∞ —Å–µ–º–µ—Å—Ç—Ä [—Å—Ä–µ–¥–Ω–µ–µ {typical_late}]: ") or typical_late)
        extracurricular = int(input("–£—á–∞—Å—Ç–≤—É–µ—Ç –≤–æ –≤–Ω–µ—É—á–µ–±–∫–µ? (1 ‚Äî –¥–∞, 0 ‚Äî –Ω–µ—Ç): "))
        
        validate_input(attendance, avg_grade, motivation, late_count, extracurricular)
        
        new_students.append([attendance, avg_grade, extracurricular, motivation, late_count, specialty])
    
    new_students_df = pd.DataFrame({
        'attendance': [s[0] for s in new_students],
        'avg_grade': [s[1] for s in new_students],
        'extracurricular': [s[2] for s in new_students],
        'motivation': [s[3] for s in new_students],
        'late_count': [s[4] for s in new_students]
    })
    
    probabilities = model.predict_proba(new_students_df)[:, 1]
    statuses = ["—É—Å–ø–µ—à–Ω—ã–π" if p >= 0.5 else "–≤ –≥—Ä—É–ø–ø–µ —Ä–∏—Å–∫–∞" for p in probabilities]
    
    results = pd.DataFrame({
        '–°—Ç—É–¥–µ–Ω—Ç': [f"–°—Ç—É–¥–µ–Ω—Ç {i+1}" for i in range(n_new)],
        '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': [s[5] for s in new_students],
        '–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å': new_students_df['attendance'],
        '–°—Ä_–æ—Ü–µ–Ω–∫–∞': new_students_df['avg_grade'],
        '–ú–æ—Ç–∏–≤–∞—Ü–∏—è': new_students_df['motivation'],
        '–û–ø–æ–∑–¥–∞–Ω–∏—è': new_students_df['late_count'],
        '–í–Ω–µ—É—á–µ–±–∫–∞': new_students_df['extracurricular'].map({1: '–î–∞', 0: '–ù–µ—Ç'}),
        '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å_—É—Å–ø–µ—Ö–∞': [f"{p:.1%}" for p in probabilities],
        '–°—Ç–∞—Ç—É—Å': statuses
    })
    
    print("\n" + "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê".center(80))
    print("=" * 80)
    print(results.to_string(index=False))
    print("=" * 80)
    
    if n_new > 0:
        create_visualizations(results, n_new)
    
    print_recommendations(results, n_new)

except ValueError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞: {e}")
except Exception as e:
    print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

print("\n" + "=" * 60)
print("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")
print("=" * 60)
